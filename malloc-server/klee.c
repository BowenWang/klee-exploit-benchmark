#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <errno.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <string.h>

#define MALLOC_OP 'm'
#define FREE_OP 'f'
#define REALLOC_OP 'r'

struct memory_op{
    size_t type;
    size_t arg1;
    size_t arg2;
};
typedef struct memory_op memory_op;

// for malloc and realloc, 
struct heapop_retval{
    // for malloc and realloc, return the allocated pointer
    // for free, just return -1.
    // can't think of anything else for now, but may add something later into
    // this struct
    size_t ret_ptr;
};
typedef struct heapop_retval heapop_retval;

int main(void)
{
    int sv[2]; /* the pair of socket descriptors */
    char buf; /* for data exchange between processes */
    sv[0] = 1000;
    sv[1] = 1001;

    if (socketpair(AF_UNIX, SOCK_STREAM, 0, sv) == -1) {
            perror("socketpair");
            exit(1);
    }
    
    printf("sv[0]: %d, sv[1]: %d\n", sv[0], sv[1]);
    if (!fork()) {  
        /* child */
        char socket_fd_for_child[8];
        sprintf(socket_fd_for_child, "%d", sv[1]);
        char *malloc_server_argv[] = {"./malloc-server", socket_fd_for_child, NULL};
        execv("./malloc-server", malloc_server_argv);
    }//else {}
    /* parent */
    memory_op test_heapop;
    heapop_retval heapop_return;
    // Let's try malloc 0x80, 0xff00, 0xff000000
    // and then free them
    // test case 1, just malloc
    /*
    while(1){
        memset(&test_heapop, 0, sizeof(memory_op));
        memset(&heapop_return, 0, sizeof(heapop_retval));
        test_heapop.type = (size_t)MALLOC_OP;
        test_heapop.arg1 = (size_t)0xffff;
        test_heapop.arg2 = (size_t)0xffff0000;
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        read(sv[0], &heapop_return, sizeof(heapop_retval));
        printf("from parent, I got 0x%lx\n", heapop_return.ret_ptr);
    }
    */
    // test case 2, malloc then free
    /*
     while(1){
        // malloc
        memset(&test_heapop, 0, sizeof(memory_op));
        memset(&heapop_return, 0, sizeof(heapop_retval));
        test_heapop.type = (size_t)MALLOC_OP;
        test_heapop.arg1 = (size_t)0xffff;
        test_heapop.arg2 = (size_t)0xffffffffffffffff;
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        read(sv[0], &heapop_return, sizeof(heapop_retval));
        printf("from parent, I got 0x%lx\n", heapop_return.ret_ptr);

        // free
        memset(&test_heapop, 0, sizeof(memory_op));
        test_heapop.type = (size_t)FREE_OP;
        test_heapop.arg1 = heapop_return.ret_ptr;
        test_heapop.arg2 = (size_t)0xff00ff00ff00ff00;
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        read(sv[0], &heapop_return, sizeof(heapop_retval));
        printf("from parent, I got 0x%lx\n", heapop_return.ret_ptr);
    }
    */   
    // test case 3, malloc then realloc
    int realloc_iterations = 0;
    while(1){
        // malloc
        memset(&test_heapop, 0, sizeof(memory_op));
        memset(&heapop_return, 0, sizeof(heapop_retval));
        test_heapop.type = (size_t)MALLOC_OP;
        test_heapop.arg1 = (size_t)0xffff;
        test_heapop.arg2 = (size_t)0xffffffffffffffff;
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        read(sv[0], &heapop_return, sizeof(heapop_retval));
        printf("from parent, I got 0x%lx\n", heapop_return.ret_ptr);

        // realloc
        memset(&test_heapop, 0, sizeof(memory_op));
        test_heapop.type = (size_t)REALLOC_OP;
        test_heapop.arg1 = heapop_return.ret_ptr;
        test_heapop.arg2 = (size_t)(0xffff + realloc_iterations * 0x10);
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        read(sv[0], &heapop_return, sizeof(heapop_retval));
        printf("from parent, I got 0x%lx\n", heapop_return.ret_ptr);

        realloc_iterations += 1;
    }
    return 0;
}
