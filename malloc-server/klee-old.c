#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <errno.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <string.h>

struct memory_op{
    size_t type;
    size_t arg1;
    size_t arg2;
};
typedef struct memory_op memory_op;

int main(void)
{
    int sv[2]; /* the pair of socket descriptors */
    char buf; /* for data exchange between processes */
    sv[0] = 1000;
    sv[1] = 1001;

    if (socketpair(AF_UNIX, SOCK_STREAM, 0, sv) == -1) {
            perror("socketpair");
            exit(1);
    }
    
    printf("sv[0]: %d, sv[1]: %d\n", sv[0], sv[1]);
    if (!fork()) {  /* child */
        char socket_fd_for_child[8];
        //itoa(sv[0], read_fd, 10);
        //itoa(sv[1], write_fd, 10);
        //sprintf(read_fd, "%d", sv[1]);
        sprintf(socket_fd_for_child, "%d", sv[1]);
        char *malloc_server_argv[] = {"./malloc-server", socket_fd_for_child, NULL};
        execv("./malloc-server", malloc_server_argv);
        /*
        memory_op recv_heapop;
        memset(&recv_heapop, 0, sizeof(memory_op));

        read(sv[1], &recv_heapop, sizeof(memory_op));
        printf("from child, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)recv_heapop.type, recv_heapop.arg1, recv_heapop.arg2);
        */
        //read(sv[1], &buf, 1);
        //printf("child: read '%c'\n", buf);
        //buf = toupper(buf);  /* make it uppercase */
        //write(sv[1], &buf, 1);
        //printf("child: sent '%c'\n", buf);

    } else { /* parent */
        memory_op test_heapop;
        memset(&test_heapop, 0, sizeof(memory_op));
        test_heapop.type = (size_t)0x6d;
        test_heapop.arg1 = (size_t)0xffff;
        test_heapop.arg2 = (size_t)0xffff0000;
        printf("from parent, type: %c, arg1: 0x%lx, arg2: 0x%lx\n", (char)test_heapop.type, test_heapop.arg1, test_heapop.arg2);
        write(sv[0], &test_heapop, sizeof(memory_op));
        //write(sv[0], "b", 1);
        //printf("parent: sent 'b'\n");
        //read(sv[0], &buf, 1);
        //printf("parent: read '%c'\n", buf);
        //wait(NULL); /* wait for child to die */
        
    }

    return 0;
}
